<!DOCTYPE html>
<html>
  <head>
    <style>
    @font-face {
      font-family: 'alice';
      src:  url('Alice_in_Wonderland_3.woff2') format('woff2'),
            url('Alice_in_Wonderland_3.woff') format('woff');
    }
    body, html{ 
      margin: 0;
      width: 100%;
      height: 100vh;
      overflow: hidden;
      background: #000;
    }
    canvas{
        position: absolute;
        top: 50%;
        left: 50%;
        width: 100%;
        height: 100%;
        background-color: #fff;
        border: 2px solid #4fc4;
        background-position: center center;
        background-size: fill;
        transform: translate(-50%, -50%);
    }
    .downloadLink{
      text-decoration: none;
      font-family: courier;
      font-size: 24px;
      color: #044;
      text-shadow: 1px 1px 1px #000;
      margin: 50px;
      padding: 10px;
      background: #0fa;
      display: inline-block;
      border-radius: 10px;
    }
    .newDiv{
      text-align: center;
    }
    .imgThumb{
      width: calc(100% - 50px);
      margin:25px;
    }
	</style>
  </head>
  <body>
    <canvas id="c"></canvas>
  </body>
  <script>

    document.fonts.onloadingdone=()=>{console.log('fonts loaded')}
    duration = window.location.href.toUpperCase().split('DURATION=')[1]
    if(typeof duration !== 'undefined' && duration.length){
      duration=+duration.split('&')[0]
    } else {
      duration = 1000*60|0
    }
    initialDelay = window.location.href.toUpperCase().split('DELAY=')[1]
    if(typeof initialDelay !== 'undefined' && initialDelay.length){
      initialDelay=+initialDelay.split('&')[0]
    } else {
      initialDelay = 4000
    }
    vars=0
    song = './epiphany.mp3'
    vid = ''
    stage2 = false
    export_base = true
    fftSize = 128
    visualization = 13
    autoStart = 1

    recordingStarted=playing=vidplaying=analyzerSetup=0
    canvas2 = document.querySelector("#c")
    canvas2.width = 1920|0
    canvas2.height = 1080|0
    x2 = canvas2.getContext('2d')
    c = canvas2.cloneNode()
    c.id = 'canvas2'
    c.style.visibility = 'hidden'
    c.style.position = 'absolute'
    document.body.appendChild(c)
    c.width=1920
    c.height=1080
    c.style.width='calc(' + 1920 + 'px - 10px)'
    c.style.height='calc(' + 1080 + 'px - 10px)'


    //c.style.display='none'
    x = c.getContext('2d')
    C = Math.cos
    S = Math.sin
    t = 0
    T = Math.tan

      rsz=window.onresize=()=>{
        setTimeout(()=>{
          if(document.body.clientWidth > document.body.clientHeight*1.77777778){
            c.style.height = '100vh'
            setTimeout(()=>c.style.width = c.clientHeight*1.77777778+'px',0)
            canvas2.style.height = '100vh'
            setTimeout(()=>canvas2.style.width = canvas2.clientHeight*1.77777778+'px',0)
          }else{
            c.style.width = '100vw'
            setTimeout(()=>c.style.height = c.clientWidth/1.77777778 + 'px',0)
            canvas2.style.width = '100vw'
            setTimeout(()=>canvas2.style.height = canvas2.clientWidth/1.77777778 + 'px',0)
          }
          //c.width=1920
          //c.height=c.width/1.777777778
        },0)
      }
      rsz()
      go=false

    async function Draw(){

      if(!t){
        R=(Rl,Pt,Yw,m)=>{X=S(p=(A=(M=Math).atan2)(X,Y)+Rl)*(d=(H=M.hypot)(X,Y)),Y=C(p)*d,Y=S(p=A(Y,Z)+Pt)*(d=H(Y,Z)),Z=C(p)*d,X=S(p=A(X,Z)+Yw)*(d=H(X,Z)),Z=C(p)*d;if(m)X+=oX,Y+=oY,Z+=oZ}
        I=(A,B,M,D,E,F,G,H)=>(K=((G-E)*(B-F)-(H-F)*(A-E))/(J=(H-F)*(M-A)-(G-E)*(D-B)))>=0&&K<=1&&(L=((M-A)*(B-F)-(D-B)*(A-E))/J)>=0&&L<=1?[A+K*(M-A),B+K*(D-B)]:0
        Q=q=>[c.width/2+X/Z*1e3,c.height/2+Y/Z*1e3]
        Rn=Math.random
        x.lineJoin=x.lineCap='butt'
      }

      if(stage2){
        if(song){
          analyzerSetup||setupAnalyzerAndContent()
        }else{
          loaded=1
        }
      } else { //base animation (pre freq)



c = document.querySelector('#c')
c.width = 1920
c.height = 1080
x = c.getContext('2d')
C = Math.cos
S = Math.sin
t = 0
T = Math.tan

rsz=window.onresize=()=>{
  setTimeout(()=>{
    if(document.body.clientWidth > document.body.clientHeight*1.77777778){
      c.style.height = '100vh'
      setTimeout(()=>c.style.width = c.clientHeight*1.77777778+'px',0)
    }else{
      c.style.width = '100vw'
      setTimeout(()=>c.style.height =     c.clientWidth/1.77777778 + 'px',0)
    }
  },0)
}
rsz()

async function Draw(){
  
  if(!t){
    R=(Rl,Pt,Yw,m)=>{
      M=Math
      A=M.atan2
      H=M.hypot
      X=S(p=A(X,Y)+Rl)*(d=H(X,Y))
      Y=C(p)*d
      X=S(p=A(X,Z)+Yw)*(d=H(X,Z))
      Z=C(p)*d
      Y=S(p=A(Y,Z)+Pt)*(d=H(Y,Z))
      Z=C(p)*d
      if(m){
        X+=oX
        Y+=oY
        Z+=oZ
      }
    }
    Q=()=>[c.width/2+X/Z*800,c.height/2+Y/Z*800]
    I=(A,B,M,D,E,F,G,H)=>(K=((G-E)*(B-F)-(H-F)*(A-E))/(J=(H-F)*(M-A)-(G-E)*(D-B)))>=0&&K<=1&&(L=((M-A)*(B-F)-(D-B)*(A-E))/J)>=0&&L<=1?[A+K*(M-A),B+K*(D-B)]:0
    
    Rn = Math.random
    
    geoSphere = (mx, my, mz, iBc, size) => {
      let collapse=0
      let B=Array(iBc).fill().map(v=>{
        X = Rn()-.5
        Y = Rn()-.5
        Z = Rn()-.5
        return  [X,Y,Z]
      })
      for(let m=99;m--;){
        B.map((v,i)=>{
          X = v[0]
          Y = v[1]
          Z = v[2]
          B.map((q,j)=>{
            if(j!=i){
              X2=q[0]
              Y2=q[1]
              Z2=q[2]
              d=1+(Math.hypot(X-X2,Y-Y2,Z-Z2)*(3+iBc/40)*3)**4
              X+=(X-X2)*99/d
              Y+=(Y-Y2)*99/d
              Z+=(Z-Z2)*99/d
            }
          })
          d=Math.hypot(X,Y,Z)
          v[0]=X/d
          v[1]=Y/d
          v[2]=Z/d
          if(collapse){
            d=25+Math.hypot(X,Y,Z)
            v[0]=(X-X/d)/1.1
            v[1]=(Y-Y/d)/1.1         
            v[2]=(Z-Z/d)/1.1
          }
        })
      }
      B.map(v=>{
        v[0]*=size
        v[1]*=size
        v[2]*=size
        v[0]+=mx
        v[1]+=my
        v[2]+=mz
      })
      return [mx, my, mz, size, B]
    }

    Cylinder = (rw,cl,ls1,ls2) => {
      let a = []
      for(let i=rw;i--;){
        let b = []
        for(let j=cl;j--;){
          X = S(p=Math.PI*2/cl*j) * ls1
          Y = (1/rw*i-.5)*ls2
          Z = C(p) * ls1
          b = [...b, [X,Y,Z]]
        }
        //a = [...a, b]
        for(let j=cl;j--;){
          b = []
          X = S(p=Math.PI*2/cl*j) * ls1
          Y = (1/rw*i-.5)*ls2
          Z = C(p) * ls1
          b = [...b, [X,Y,Z]]
          X = S(p=Math.PI*2/cl*(j+1)) * ls1
          Y = (1/rw*i-.5)*ls2
          Z = C(p) * ls1
          b = [...b, [X,Y,Z]]
          X = S(p=Math.PI*2/cl*(j+1)) * ls1
          Y = (1/rw*(i+1)-.5)*ls2
          Z = C(p) * ls1
          b = [...b, [X,Y,Z]]
          X = S(p=Math.PI*2/cl*j) * ls1
          Y = (1/rw*(i+1)-.5)*ls2
          Z = C(p) * ls1
          b = [...b, [X,Y,Z]]
          a = [...a, b]
        }
      }
      b = []
      for(let j=cl;j--;){
        X = S(p=Math.PI*2/cl*j) * ls1
        Y = ls2/2
        Z = C(p) * ls1
        b = [...b, [X,Y,Z]]
      }
      //a = [...a, b]
      return a
    }

    Tetrahedron = size => {
      ret = []
      a = []
      let h = size/1.4142/1.25
      for(i=3;i--;){
        X = S(p=Math.PI*2/3*i) * size/1.25
        Y = C(p) * size/1.25
        Z = h
        a = [...a, [X,Y,Z]]
      }
      ret = [...ret, a]
      for(j=3;j--;){
        a = []
        X = 0
        Y = 0
        Z = -h
        a = [...a, [X,Y,Z]]
        X = S(p=Math.PI*2/3*j) * size/1.25
        Y = C(p) * size/1.25
        Z = h
        a = [...a, [X,Y,Z]]
        X = S(p=Math.PI*2/3*(j+1)) * size/1.25
        Y = C(p) * size/1.25
        Z = h
        a = [...a, [X,Y,Z]]
        ret = [...ret, a]
      }
      ax=ay=az=ct=0
      ret.map(v=>{
        v.map(q=>{
          ax+=q[0]
          ay+=q[1]
          az+=q[2]
          ct++
        })
      })
      ax/=ct
      ay/=ct
      az/=ct
      ret.map(v=>{
        v.map(q=>{
          q[0]-=ax
          q[1]-=ay
          q[2]-=az
        })
      })
      return ret
    }

    Cube = size => {
      for(CB=[],j=6;j--;CB=[...CB,b])for(b=[],i=4;i--;)b=[...b,[(a=[S(p=Math.PI*2/4*i+Math.PI/4),C(p),2**.5/2])[j%3]*(l=j<3?size/1.5:-size/1.5),a[(j+1)%3]*l,a[(j+2)%3]*l]]
      return CB
    }
    
    Octahedron = size => {
      ret = []
      let h = size/1.25
      for(j=8;j--;){
        a = []
        X = 0
        Y = 0
        Z = h * (j<4?-1:1)
        a = [...a, [X,Y,Z]]
        X = S(p=Math.PI*2/4*j) * size/1.25
        Y = C(p) * size/1.25
        Z = 0
        a = [...a, [X,Y,Z]]
        X = S(p=Math.PI*2/4*(j+1)) * size/1.25
        Y = C(p) * size/1.25
        Z = 0
        a = [...a, [X,Y,Z]]
        ret = [...ret, a]
      }
      return ret      
    }
    
    Dodecahedron = size => {
      ret = []
      a = []
      mind = -6e6
      for(i=5;i--;){
        X=S(p=Math.PI*2/5*i + Math.PI/5)
        Y=C(p)
        Z=0
        if(Y>mind) mind=Y
        a = [...a, [X,Y,Z]]
      }
      a.map(v=>{
        X = v[0]
        Y = v[1]-=mind
        Z = v[2]
        R(0, .553573, 0)
        v[0] = X
        v[1] = Y
        v[2] = Z
      })
      b = JSON.parse(JSON.stringify(a))
      b.map(v=>{
        v[1] *= -1
      })
      ret = [...ret, a, b]
      mind = -6e6
      ret.map(v=>{
        v.map(q=>{
          X = q[0]
          Y = q[1]
          Z = q[2]
          if(Z>mind)mind = Z
        })
      })
      d1=Math.hypot(ret[0][0][0]-ret[0][1][0],ret[0][0][1]-ret[0][1][1],ret[0][0][2]-ret[0][1][2])
      ret.map(v=>{
        v.map(q=>{
          q[2]-=mind+d1/2
        })
      })
      b = JSON.parse(JSON.stringify(ret))
      b.map(v=>{
        v.map(q=>{
          q[2]*=-1
        })
      })
      ret = [...ret, ...b]
      b = JSON.parse(JSON.stringify(ret))
      b.map(v=>{
        v.map(q=>{
          X = q[0]
          Y = q[1]
          Z = q[2]
          R(0,0,Math.PI/2)
          R(0,Math.PI/2,0)
          q[0] = X
          q[1] = Y
          q[2] = Z
        })
      })
      e = JSON.parse(JSON.stringify(ret))
      e.map(v=>{
        v.map(q=>{
          X = q[0]
          Y = q[1]
          Z = q[2]
          R(0,0,Math.PI/2)
          R(Math.PI/2,0,0)
          q[0] = X
          q[1] = Y
          q[2] = Z
        })
      })
      ret = [...ret, ...b, ...e]
      ret.map(v=>{
        v.map(q=>{
          q[0] *= size/2
          q[1] *= size/2
          q[2] *= size/2
        })
      })
      return ret
    }
    
    Icosahedron = size => {
      ret = []
      B = [
        [[0,3],[1,0],[2,2]],
        [[0,3],[1,0],[1,3]],
        [[0,3],[2,3],[1,3]],
        [[0,2],[2,1],[1,0]],
        [[0,2],[1,3],[1,0]],
        [[0,2],[1,3],[2,0]],
        [[0,3],[2,2],[0,0]],
        [[1,0],[2,2],[2,1]],
        [[1,1],[2,2],[2,1]],
        [[1,1],[2,2],[0,0]],
        [[1,1],[2,1],[0,1]],
        [[0,2],[2,1],[0,1]],
        [[2,0],[1,2],[2,3]],
        [[0,0],[0,3],[2,3]],
        [[1,3],[2,0],[2,3]],
        [[2,3],[0,0],[1,2]],
        [[1,2],[2,0],[0,1]],
        [[0,0],[1,2],[1,1]],
        [[0,1],[1,2],[1,1]],
        [[0,2],[2,0],[0,1]],
      ]
      for(p=[1,1],i=38;i--;)p=[...p,p[l=p.length-1]+p[l-1]]
      phi = p[l]/p[l-1]
      a = [
        [-phi,-1,0],
        [phi,-1,0],
        [phi,1,0],
        [-phi,1,0],
      ]
      for(j=3;j--;ret=[...ret, b])for(b=[],i=4;i--;) b = [...b, [a[i][j],a[i][(j+1)%3],a[i][(j+2)%3]]]
      ret.map(v=>{
        v.map(q=>{
          q[0]*=size/2.25
          q[1]*=size/2.25
          q[2]*=size/2.25
        })
      })
      cp = JSON.parse(JSON.stringify(ret))
      out=[]
      a = []
      B.map(v=>{
        idx1a = v[0][0]
        idx2a = v[1][0]
        idx3a = v[2][0]
        idx1b = v[0][1]
        idx2b = v[1][1]
        idx3b = v[2][1]
        a = [...a, [cp[idx1a][idx1b],cp[idx2a][idx2b],cp[idx3a][idx3b]]]
      })
      out = [...out, ...a]
      return out
    }
    
    stroke = (scol, fcol, lwo=1) => {
      if(scol){
        x.closePath()
        x.globalAlpha = .2
        x.strokeStyle = scol
        x.lineWidth = Math.min(100, 2000*lwo/Z)
        x.stroke()
        x.lineWidth /= 8
        x.globalAlpha = 1
        x.stroke()
      }
      if(fcol){
        x.fillStyle = fcol
        x.fill()
      }
    }
    Rn = Math.random
    
    LsystemRecurse = (size, splits, p1, p2, stem, theta, LsystemReduction, twistFactor) => {
      if(size < .7) return
      let X1 = stem[0]
      let Y1 = stem[1]
      let Z1 = stem[2]
      let X2 = stem[3]
      let Y2 = stem[4]
      let Z2 = stem[5]
      let p1a = Math.atan2(X2-X1,Z2-Z1)
      let p2a = -Math.acos((Y2-Y1)/(Math.hypot(X2-X1,Y2-Y1,Z2-Z1)+.0001))+Math.PI
      size/=LsystemReduction
      for(let i=splits;i--;){
        X = 0
        Y = -size
        Z = 0
        R(0, theta, 0)
        R(0, 0, Math.PI*2/splits*i+twistFactor)
        R(0, p2a, 0)
        R(0, 0, p1a+twistFactor)
        X+=X2
        Y+=Y2
        Z+=Z2
        let newStem = [X2, Y2, Z2, X, Y, Z]
        Lshp = [...Lshp, newStem]
        LsystemRecurse(size, splits, p1+Math.PI*2/splits*i+twistFactor, p2+theta, newStem, theta, LsystemReduction, twistFactor)
      }
    }
    DrawLsystem = shp => {
      shp.map(v=>{
        x.beginPath()
        X = v[0]
        Y = v[1]
        Z = v[2]
        R(Rl,Pt,Yw,1)
        if(Z>0)x.lineTo(...Q())
        X = v[3]
        Y = v[4]
        Z = v[5]
        R(Rl,Pt,Yw,1)
        if(Z>0)x.lineTo(...Q())
        lwo = Math.hypot(v[0]-v[3],v[1]-v[4],v[2]-v[5])
        stroke('#0f82','',lwo)
      })
      
    }
    Lsystem = (size, splits, theta, LsystemReduction, twistFactor) => {
      Lshp = []
      stem = [0,0,0,0,-size,0]
      Lshp = [...Lshp, stem]
      LsystemRecurse(size, splits, 0, 0, stem, theta, LsystemReduction, twistFactor)
      Lshp.map(v=>{
        v[1]+=size*1.5
        v[4]+=size*1.5
      })
      return Lshp
    }
    
    Sphere = (ls, rw, cl) => {
      a = []
      ls/=1.25
      for(j = rw; j--;){
        for(i = cl; i--;){
          b = []
          X = S(p = Math.PI*2/cl*i) * S(q = Math.PI/rw*j) * ls
          Y = C(q) * ls
          Z = C(p) * S(q) * ls
          b = [...b, [X,Y,Z]]
          X = S(p = Math.PI*2/cl*(i+1)) * S(q = Math.PI/rw*j) * ls
          Y = C(q) * ls
          Z = C(p) * S(q) * ls
          b = [...b, [X,Y,Z]]
          X = S(p = Math.PI*2/cl*(i+1)) * S(q = Math.PI/rw*(j+1)) * ls
          Y = C(q) * ls
          Z = C(p) * S(q) * ls
          b = [...b, [X,Y,Z]]
          X = S(p = Math.PI*2/cl*i) * S(q = Math.PI/rw*(j+1)) * ls
          Y = C(q) * ls
          Z = C(p) * S(q) * ls
          b = [...b, [X,Y,Z]]
          a = [...a, b]
        }
      }
      return a
    }
    
    init = () => {
      gearSetNo = 6
      gearSet = []
      for(K=gearSetNo;K--;){
        gears = [[0,0,0,8,0,false]]
        addGear = () => {
          do{
            lidx = (gears.length*Rn()**.1)|0
            X = gears[lidx][0]
            Y = gears[lidx][1]
            Z = gears[lidx][2]
            theta = gears[lidx][4]
            ls = gears[lidx][3]*(Rn()<.5&&gears[lidx][3]>8?n=1:(gears[lidx][3]<16?n=4:n=1))
            sd = (ls/2)*2400|0
            p = otheta += (!(m%3))?Math.PI/2*(Rn()<.5?1:-1)*(Rn()<.5?2:1):0
            tx = X + S(p) * ls/(n==4?2:1)
            ty = Y + C(p) * ls/(n==4?2:1)
            tz = Z 
            g=!!gears.filter(v=>Math.hypot(v[0]-tx,v[1]-ty,v[2]-tz)<ls/2).length
          }while(g);
          X += S(p) * (ls)/(n==4?2:1)
          Y += C(p) * (ls)/(n==4?2:1)
          Z += 0
          dir = !(gears[lidx][5])
          gears=[...gears, [X,Y,Z,ls/2,p/2/sd,dir]]//
        }
        dir=0
        otheta=0
        for(m=16;m--;)addGear()
        cx=cy=cz=0
        gears.map(v=>{
          cx += v[0]
          cy += v[1]
          cz += v[2]
        })
        cx/=gears.length
        cy/=gears.length
        cz/=gears.length
        gears.map(v=>{
          v[0]-=cx
          v[1]-=cy
          v[2]-=cz
          v[2]+= (-gearSetNo/2+K+.5)*32
        })
        gearSet = [gears, ...gearSet]
      }
    }
    init()
    go = false
    bg = new Image()
    bg.onload=()=>{
       go = true
    }
    bg.src = "proxy.php?url=https://srmcgann.github.io/temp/bg.jpg"
  }

  oX=0, oY=0, oZ=150
  Rl = S(t/4)*2, Pt = C(t)/4, Yw = S(t/8)*8
  
  if(go){
    x.globalAlpha = .2
    x.drawImage(bg,0,-200,c.width,c.height+400)
    x.globalAlpha = 1
    x.fillStyle='#f446'
    x.fillRect(0,0,c.width,c.height)
    x.lineJoin = x.lineCap = 'roud'

    speed = 1*C(t/2)
    gearSet.map((gears,gearSetIdx) => {
      gears.map((v,i) => {
        tx = v[0]
        ty = v[1]
        tz = v[2]
        v[4] += (v[5]%2?speed:-speed)/v[3]
        x.beginPath()
        for(j=(sd = (v[3]/2) * 2400 / 100|0); j--;){
          ls = (v[3]-.125) + .25 * (Math.max(-4,Math.min(4,(-.25+S(Math.PI*2/sd*j*(sd/12|0)))*10)))
          X = tx + S(p=Math.PI*2/sd*j+v[4]+(i%2?Math.PI/sd:0))*ls/1.5
          Y = ty + C(p)*ls/1.5
          Z = tz
          R(Rl,Pt,Yw,1)
          if(Z>0) x.lineTo(...Q())
        }
        stroke('#0006', `hsla(${t*200+360/gearSet.length*gearSetIdx},99%,50%,.05)`)
      })
    })
  }  
  t+=1/60
  requestAnimationFrame(Draw)
}
Draw()

	      

t+=1/60

      }

      if(stage2 && loaded){

        if(!recordingStarted && export_base) startRecording()

        switch(visualization){
          case 0:
            scaleX=2
            framels=5
            if(vid){
              x.globalAlpha=.5
              x.drawImage(bgvid,0,0,w=c.width,c.height)
              x.globalAlpha=1
            }else{
              x.fillStyle='#0006'
              x.fillRect(0,0,w=c.width,w)
            }
            
            G=2
            oX=0,oY=0,oZ=7+S(t)*2
            Rl=S(t/1.5)/4,Pt=S(t)/4,Yw=S(t*1.5)/2
            if(playing){
              B = new Uint8Array(bufferLength)
              analyser.getByteFrequencyData(B)
            } else {
              trim=0
              B=Array(64).fill(1)
            }

            x.beginPath()
            x.lineWidth=framels
            X=G*scaleX,Y=G,Z=0,R(Rl,Pt,Yw,1)
            x.lineTo(...Q())
            X=G*scaleX,Y=-G,Z=0,R(Rl,Pt,Yw,1)
            x.lineTo(...Q())
            X=-G*scaleX,Y=-G,Z=0,R(Rl,Pt,Yw,1)
            x.lineTo(...Q())
            X=-G*scaleX,Y=G,Z=0,R(Rl,Pt,Yw,1)
            x.lineTo(...Q())
            X=G*scaleX,Y=G,Z=0,R(Rl,Pt,Yw,1)
            x.lineTo(...Q())
            x.strokeStyle=`hsla(${t*99},99%,70%,.1`
            x.fillStyle=`hsla(${t*99},99%,20%,.2`
            x.stroke()
            x.fill()

            B.map((v,i)=>{
              if(v&&i<B.length-trim){
                X=(G/(B.length-trim)*(i+.5)-G/2)*scaleX*2
                Y=G/128*(128-v/1.1+1)-(G/10)
                Z=0
                R(Rl,Pt,Yw,1)
                x.beginPath()
                x.lineTo(...Q())
                X=(G/(B.length-trim)*(i+.5)-G/2)*scaleX*2
                Y=G-(G/10)
                Z=0
                R(Rl,Pt,Yw,1)
                x.lineTo(...Q())
                x.strokeStyle=`hsla(${360/(B.length-trim)*i+360/128*v+t*900},50%,${40+50/1e9*(v**4)}%,.4)`
                x.lineWidth=750/(1+Z)/(2+(Z)/3.5)
                x.stroke()
                x.strokeStyle=`hsla(${360/(B.length-trim)*i+360/128*v+t*900},50%,${60+40/1e9*(v**4)}%,1)`
                x.lineWidth=350/(1+Z)/(2+(Z)/3.5)
                x.stroke()
              }
            })
          t+= 1/60
          break
          case 1:
          
            if(vid){
              x.globalAlpha=.5
              x.drawImage(bgvid,0,0,w=c.width,c.height)
              x.globalAlpha=1
              x.fillStyle='#0004'
              x.fillRect(0,0,w=c.width,w)
            }else{
              x.fillStyle='#0006'
              x.fillRect(0,0,w=c.width,w)
            }

            G=2
            oX=0,oY=0,oZ=G+S(t*2)
            Rl=t,Pt=0,Yw=C(t/2)
            
            if(playing){
              B = new Uint8Array(bufferLength)
              analyser.getByteFrequencyData(B)
              iPc=B.length-trim
            }else{
              iPc=32,B=Array(iPc).fill(0)
            }
            

            if(!t){
              x.lineCap=x.lineJoin='round'
              P=Array(iPc).fill().map((v,i)=>{
                X=G/iPc*(i-iPc/2)*1
                Y=G/3
                Z=0
                return [X,Y,Z,1,[]]
              })
            }

            P.map((v,k)=>{
              ty=v[1]+(B[k]-128)/250
              X=v[0]
              Y=ty
              Z=v[2]
              R(Rl,Pt,Yw,1)
              x.beginPath()
              x.lineTo(...Q())
              v[4].map((q,j)=>{
                X=v[4][l=v[4].length-j-1][0]
                Y=v[4][l][1]
                Z=v[4][l][2]
                v[4][l][2]+=.08
                R(Rl,Pt,Yw,1)
                if(j<v[4].length-1){
                  x.beginPath()
                  x.lineTo(...Q())
                  X=v[4][l=v[4].length-j-2][0]
                  Y=v[4][l][1]
                  Z=v[4][l][2]
                  R(Rl,Pt,Yw,1)
                  x.lineTo(...Q())
                  x.strokeStyle=`hsla(${360/128*B[k]-t*800+j*10},99%,${150-60/128*B[k]}%,.4)`
                  x.lineWidth=30*v[4][l][3]/Z
                  if(Z>.5)x.stroke()
                }
                v[4][l][3]/=1.05
              })
              v[4].push([v[0],ty,v[2],v[3]/1.05])
              v[4]=v[4].filter(v=>v[3]>.05)
            })
            P.map((v,k)=>{
              X=v[0]
              Y=-v[1]
              Z=v[2]
              R(Rl,Pt,Yw,1)
              x.beginPath()
              x.lineTo(...Q())
              v[4].map((q,j)=>{
                X=v[4][l=v[4].length-j-1][0]
                Y=-v[4][l][1]
                Z=v[4][l][2]
                R(Rl,Pt,Yw,1)
                if(j<v[4].length-1){
                  x.beginPath()
                  x.lineTo(...Q())
                  X=v[4][l=v[4].length-j-2][0]
                  Y=-v[4][l][1]
                  Z=v[4][l][2]
                  R(Rl,Pt,Yw,1)
                  x.lineTo(...Q())
                  x.strokeStyle=`hsla(${360/128*B[k]+t*800+j*10},99%,${150-60/128*B[k]}%,.4)`
                  x.lineWidth=30*v[4][l][3]/Z
                  if(Z>.5)x.stroke()
                }
              })
            })
            
            t+= 1/60
          break
          
          case 2:
          
            scaleX=2
            framels=5
            if(vid){
              x.globalAlpha=.5
              x.drawImage(bgvid,0,0,w=c.width,c.height);
              x.globalAlpha=1
              x.fillStyle='#0005'
              x.fillRect(0,0,w=c.width,w)
            }else{
              x.fillStyle='#0004'
              x.fillRect(0,0,w=c.width,w)
            }
            
            oX=0,oY=0,oZ=10
            Rl=0,Pt=-t/1.5,Yw=t
            if(playing){
              B = new Uint8Array(bufferLength)
              analyser.getByteFrequencyData(B)
            } else {
              trim=0
              B=Array(64).fill(1)
            }

            if(!t){
              x.lineJoin=x.lineCap='round'
              cl=30,rw=16,iSr=2
              P=Array(cl*(rw+1)|0).fill().map((v,i)=>{
                j=i/cl|0
                X=S(p=Math.PI*2/cl*i)*S(q=Math.PI/(rw)*j)*iSr
                Y=C(q)*iSr
                Z=C(p)*S(q)*iSr
                return [X,Y,Z,0]
              })
            }
            P.map((v,i)=>{
              
              d3=Math.hypot(...v)
              v[1]=v[1]/d3*iSr
              v[0]=v[0]/d3*iSr*(d1=1+B[l=cl/B.length*(i%cl)|0]**2/19999/(((1+Math.abs(v[1]))**.5*5))*3)
              v[1]=v[1]*d1
              v[2]=v[2]/d3*iSr*d1

              X=v[0]
              Y=v[1]
              Z=v[2]
              R(Rl,Pt,Yw,1)
              x.beginPath()
              x.lineTo(...Q())
              if((i%cl)==cl-1){
                X=P[l=i-cl+1][0]
                Y=P[l][1]
                Z=P[l][2]
              } else {
                X=P[i+1][0]
                Y=P[i+1][1]
                Z=P[i+1][2]
              }
              R(Rl,Pt,Yw,1)
              x.lineTo(...Q())
              x.strokeStyle=`hsla(${d3*80-t*399},99%,${Math.max(40,95-(1+d3)**5/70)}%,.1`
              x.lineWidth=1+999/Z/Z
              x.stroke()
              x.strokeStyle=`hsla(${d3*80-t*399},99%,${Math.max(40,115-(1+d3)**5/70)}%,.6`
              x.lineWidth=1+200/Z/Z
              x.stroke()

              if(i<P.length-cl){
                if((i+1)%cl){
                  X=P[l=i+cl+1][0]
                  Y=P[l][1]
                  Z=P[l][2]
                }else{
                  X=P[l=i+1][0]
                  Y=P[l][1]
                  Z=P[l][2]
                }
                R(Rl,Pt,Yw,1)
                x.lineTo(...Q())
                x.strokeStyle=`hsla(${d3*80-t*399},99%,${Math.max(40,95-(1+d3)**5/70)}%,.1`
                x.lineWidth=1+999/Z/Z
                x.stroke()
                x.strokeStyle=`hsla(${d3*80-t*399},99%,${Math.max(40,115-(1+d3)**5/70)}%,.6`
                x.lineWidth=1+200/Z/Z
                x.stroke()
              }
            })
          
            t+= 1/60
          break
          case 3:
            x.fillStyle='#0008',x.fillRect(0,0,w=c.width,w)
            
            if(!t){
              x.lineJoin=x.lineCap='round'
              cl=100,iBc=16,iBr=10,iBv=16
              rw=cl/aspect
              ls=w/cl
              P=Array(cl*(rw+1)|0).fill().map((v,i)=>[(i%cl)*ls,(i/cl|0)*ls])
              E=Array(iBc).fill().map(v=>[iBr+Rn()*(w-iBr*2),iBr+Rn()*(c.height-iBr*2),S(p=Rn()*Math.PI)*iBv,C(p)*iBv])
            }

            if(playing){
              B = new Uint8Array(bufferLength)
              analyser.getByteFrequencyData(B)
              amp=0
              B.map((v,i)=>amp+=v*(1+(B.length/2-Math.abs(B.length/2-i))/2))
            } else {
              trim=0
              B=Array(64).fill(1)
            }

            P.map(v=>{
              e=0
              E.map(q=>{
                d=Math.hypot(q[0]-(v[0]+ls/2),q[1]-(v[1]+ls/2))
                e+=5/(d**1.35/600)*(1+amp**4/300000000000000)
              })
              x.fillStyle=`hsla(${e*1.5-65},99%,${Math.min(100,e)}%,1`
              x.fillRect(...v,ls+1,ls+1)
              /*
              x.strokeStyle='#fff1'
              x.lineWidth=ls/10
              x.strokeRect(...v,ls,ls)
              */
            })

            E.map(v=>{
              if(v[0]>w-iBr||v[0]<iBr)v[2]*=-1
              if(v[1]>c.height-iBr||v[1]<iBr)v[3]*=-1
              x.beginPath()
              x.arc(v[0],v[1],iBr,0,7)
              x.fillStyle='#aff6'
              x.fill()
              x.beginPath()
              x.arc(v[0],v[1],iBr/1.75,0,7)
              x.fillStyle='#6aa8'
              x.fill()
              v[0]+=v[2]
              v[1]+=v[3]
            })
            
            t+=1/60
          break
          case 4:
            x.lineJoin=x.lineCap='round'
            if(playing){
              B = new Uint8Array(bufferLength)
              analyser.getByteFrequencyData(B)
              amp=0
              B.map((v,i)=>{amp+=v*(1+(B.length/2-Math.abs(B.length/2-i))/2)})
            } else {
              trim=0
              B=Array(fftSize).fill(1)
            }
            Q=q=>{
              with(x)
              beginPath(),
              lineWidth=w/Z**3.15*(o>-1?20:20.5),
              moveTo(q[0],q[1]),
              lineTo(q[2],q[3])
              if(i>l-3){
                lineWidth=w/2**2.5*v,
                x.moveTo(w-q[5]/14*h,h+4/14*h*q[4][0]),
                x.lineTo(q[0],q[1])
              }
              x.stroke()
            }
            R=s=>{
              for(n=3;n--;){
                ls=1
                if(playing){
                  B.map((v,i)=>{
                    switch(2-n){
                      case 0: if(i<fftSize/3)ls+=v/2000; break
                      case 1: if(i>=fftSize/3 && i<fftSize/3*2)ls+=v/400; break
                      case 2: if(i<=fftSize-fftSize/3)ls+=v/2000; break
                    }
                  })
                }
                ls=ls**4
                ls=1+ls/10
                for(k=2;k--;){
                  for(l=i=24;i--;){
                    X=S(p=(Math.PI/2+Math.PI*2/38*i)*(g=k?1:-1))-1*g
                    Y=(C(p)-2)*ls
                    p=Math.atan2(X,0)-t*4
                    d=(X*X)**.5*ls
                    ox=-12+n*12
                    X=S(q=p+Math.PI*2/9*s[1]*1.425+t*2)*d*s[0]-ox
                    Z=C(q)*d+14
                    D=w+X/Z*h
                    E=h+(Y+2)/Z*h*s[0]
                    //x.strokeStyle=`rgba(${255},${v=(o=s[2]>-1)?150:3},${v},${.85/((s[0]/2)**3*(o?8:1))}`
                    v=(o=s[2]>-1)?150:3
                    if(s[0]==1){
                      x.strokeStyle='#f008'
                    }else{
                      x.strokeStyle=`hsla(${255+360/24*i+t*500},99%,${120-Math.min(50,s[2]**3)}%,${.5/((s[0]/2)**3*(o?8:1))}`
                    }
                    if(i-l+1)Q([A,G,D,E,s,ox,ls])
                    A=D,G=E
                  }
                }
              }
          }
          if(typeof bgvid !== 'undefined'){
            x.globalAlpha=.3
            x.drawImage(bgvid,0,0,(w=c.width/2)*2,c.height)
            x.globalAlpha=1
            x.fillStyle='#0002'
            x.fillRect(0,0,w*2,w*2)
          }else{
            x.fillStyle='#0002'
            x.fillRect(0,0,(w=c.width/2)*2,c.height)
          }
          h=c.height/2
          R([1,0])
          for(j=16;j--;)R([1+(v=j/5.3+(t*1.5)%(1/5.3)),v,j])

          t+=1/60
          break
          
          case 5:

            if(typeof bgvid !== 'undefined'){
              x.globalAlpha=.5
              x.drawImage(bgvid,0,0,w=c.width,c.height)
              x.globalAlpha=1
              //x.fillStyle='#0000'
              //x.fillRect(0,0,w=c.width,w)
            }else{
              x.fillStyle='#0004'
              x.fillRect(0,0,w=c.width,w)
            }

            Rl=t/6,Pt=S(t/2)/2,Yw=S(t/1.5)/1.5
            oX=0,oY=0,oZ=4+S(t/1.5)/1.75
            mt=S(t/4)
            
            if(!t){
              I=(A,B,M,D,E,F,G,H)=>(K=((G-E)*(B-F)-(H-F)*(A-E))/(J=(H-F)*(M-A)-(G-E)*(D-B)))>=0&&K<=1&&(L=((M-A)*(B-F)-(D-B)*(A-E))/J)>=0&&L<=1?[A+K*(M-A),B+K*(D-B)]:0
              x.lineJoin=x.lineCap='round'
              sd=6
              iBr=2,iPv=.006,iPsv=.025,iPc=8,iPs=150,iRm=iPv*65,iRsm=iPsv*2.75,iPbv=.02
              B=Array(sd).fill().map((v,i)=>{
                return [S(p=Math.PI*2/sd*i)*iBr,C(p)*iBr,0]
              })
              P=Array(iPc).fill().map(v=>{return {X:0,Y:0,Z:0,vx:S(p=Rn()*Math.PI*2)*iPv,vy:C(p)*iPv,vz:0,theta:0,P:[]}})
            }

            P.map((v,j)=>{
              x3_=v.X+=v.vx
              y3_=v.Y+=v.vy
              z3_=v.Z+=v.vz
              d=Math.hypot(v.vx,v.vy,v.vz)
              vxd=v.vx/d*iRm
              vyd=v.vy/d*iRm
              vzd=v.vz/d*iRm
              x4_=x3_+vxd
              y4_=y3_+vyd
              z4_=z3_+vzd
              B.map((q,i)=>{
                if(i){
                  X=B[i-1][0]
                  Y=B[i-1][1]
                  Z=0
                }else{
                  X=B[l=B.length-1][0]
                  Y=B[l][1]
                  Z=0
                }
                R(mt,0,0,0)
                x2_=X,y2_=Y
                X=q[0],Y=q[1],Z=0
                R(mt,0,0,0)
                x1_=X,y1_=Y
                if(a=I(x1_,y1_,x2_,y2_,x3_,y3_,x4_,y4_)){
                  u=((x3_-x1_)*(x2_-x1_)+(y3_-y1_)*(y2_-y1_))/Math.hypot(x2_-x1_,y2_-y1_)
                  mx=u*(x2_-x1_)
                  my=u*(y2_-y1_)
                  v.vx+=S(p=Math.atan2(mx-v.X,my-v.Y)-Math.PI/2)/80
                  v.vy+=C(p)/80
                }
              })
              d=Math.hypot(v.vx,v.vy)
              v.vx/=d
              v.vy/=d
              v.vx*=iPv
              v.vy*=iPv
              for(m=3;m--;)v.P.push([v.X,v.Y,v.Z,S(p=v.theta+=Math.PI/sd*(1+j==3?5:1+j)+S(t/1.5)/16)*iPsv,C(p)*iPsv,0,iPs])
              v.P.map(v=>{

                x3_=v[0]
                y3_=v[1]
                z3_=v[2]
                d=Math.hypot(v[3],v[4],v[5])
                vxd=v[3]/d*iRsm
                vyd=v[4]/d*iRsm
                vzd=v[5]/d*iRsm
                x4_=x3_+vxd
                y4_=y3_+vyd
                z4_=z3_+vzd
                bnc=0
                B.map((q,i)=>{
                  if(i){
                    X=B[i-1][0]
                    Y=B[i-1][1]
                    Z=0
                  }else{
                    X=B[l=B.length-1][0]
                    Y=B[l][1]
                    Z=0
                  }
                  R(mt,0,0,0)
                  x2_=X,y2_=Y
                  X=q[0],Y=q[1],Z=0
                  R(mt,0,0,0)
                  x1_=X,y1_=Y
                  if(!bnc&&(a=I(x1_,y1_,x2_,y2_,x3_,y3_,x4_,y4_))){
                    bnc=0
                    u=((x3_-x1_)*(x2_-x1_)+(y3_-y1_)*(y2_-y1_))/Math.hypot(x2_-x1_,y2_-y1_)
                    mx=u*(x2_-x1_)
                    my=u*(y2_-y1_)
                    v[3]+=S(p=Math.atan2(mx-v[0],my-v[1])-.8)/80*(d=.25+Math.hypot(v[3],v[4])*100)
                    v[4]+=C(p)/100*d
                  }
                })
                d=Math.hypot(v[3],v[4])
                v[3]/=d
                v[4]/=d
                v[3]*=iPsv
                v[4]*=iPsv

                X=v[0]+=v[3]
                Y=v[1]+=v[4]
                Z=v[2]+=v[5]
                R(Rl,Pt,Yw,1)
                if(Z>0){
                  x.beginPath()
                  x.arc(...Q(),Math.min(99,(v[6]-=1.5)/Z/Z),0,7)
                  x.fillStyle='#4f84'
                  x.fill()
                }
              })
              v.P=v.P.filter(v=>v[6]>10)
            })

            B.map((v,i)=>{
              x.beginPath()
              if(i){
                X=B[i-1][0]
                Y=B[i-1][1]
                Z=B[i-1][2]
              }else{
                X=B[l=B.length-1][0]
                Y=B[l][1]
                Z=B[l][2]
              }
              R(mt,0,0,0)
              R(Rl,Pt,Yw,1)
              x.lineTo(...Q())
              X=v[0]
              Y=v[1]
              Z=v[2]
              R(mt,0,0,0)
              R(Rl,Pt,Yw,1)
              x.lineTo(...Q())
              x.strokeStyle='#84f6'
              x.lineWidth=50/Z
              x.stroke()
            })

            t+=1/60
            
          break
          case 6:

            x.globalAlpha=.07*(.25-C(t*1.5)/4)
            x.drawImage(bgimg,0,0,w=c.width,1080)
            x.globalAlpha=1
            x.fillStyle='#00000018'
            x.fillRect(0,0,w,w)
            
            oX=0,oY=0,oZ=4
            Rl=0,Pt=-t/2,Yw=S(t/3)*4
            
            if(!t){
              iPv=.002,iPsv=.005,iPc=10,iPsf=5,iPss=2,iPrr=.025
              G=2
              SP=v=>[S(p=Math.PI*2*Rn())*S(q=Math.PI*(Rn()**.5)/-2+Math.PI*(Rn()<.5?0:1))*v,C(q)*v,C(p)*S(q)*v]
              P=Array(iPc).fill().map(v=>[G*(Rn()-.5),G*(Rn()-.5),G*(Rn()-.5),...SP(iPv),[]])
            }
            
            if(playing){
              B = new Uint8Array(bufferLength)
              analyser.getByteFrequencyData(B)
              amp=0
              B.map((v,i)=>amp+=v*5**4)
              amp/=550000
            } else {
              trim=0
              B=Array(64).fill(1)
            }

            P.map((v,j)=>{
              v[0]+=v[3]
              v[1]+=v[4]
              v[2]+=v[5]
              if(v[0]<-G/2||v[0]>G/2)v[3]*=-1
              if(v[1]<-G/2||v[1]>G/2)v[4]*=-1
              if(v[2]<-G/2||v[2]>G/2)v[5]*=-1
              for(m=iPsf;m--;)v[6]=[...v[6],[v[0],v[1],v[2],...SP(iPsv),iPss]]
              v[6]=v[6].filter(q=>q[6]>.3)
              v[6].map(q=>{
                d1=Math.hypot(q[0]-v[0],q[1]-v[1],q[2]-v[2])
                X=v[0]+(q[0]+=q[3]*=1.04)
                Y=v[1]+(q[1]+=q[4]*=1.04)
                Z=v[2]+(q[2]+=q[5]*=1.04)
                R(Rl,Pt,Yw,1)
                if(Z>0){
                  x.fillStyle=`hsla(${d1*120-t*400+360/P.length*j},99%,${Math.max(50, amp*15+88-((d1+1)**3*20))}%,${.05/(1+(1+d1)**4/350)})`
                  l=Q(),s=Math.min(500,(.75+amp**3.5/40)*(q[6]-=iPrr)*150/Z/Z)
                  x.fillRect(l[0]-s/2,l[1]-s/2,s,s)
                }
              })
            })
            
            t+=1/60

          break;
          case 7:
          
            if(!t){
              R=(Rl,Pt,Yw,o)=>{
                X=S(p=(A=(M=Math).atan2)(X,Y)+Rl)*(d=(H=M.hypot)(X,Y)),Y=C(p)*d,Y=S(p=A(Y,Z)+Pt)*(d=H(Y,Z)),Z=C(p)*d,X=S(p=A(X,Z)+Yw)*(d=H(X,Z)),Z=C(p)*d
                if(o)X+=oX,Y+=oY,Z+=oZ
              }
              Q=q=>[c.width/2+X/Z*800,c.height/2+Y/Z*800]
              Rn=Math.random
            }
            
            if(typeof bgvid !== 'undefined'){
              x.globalAlpha=.4
              x.drawImage(bgvid,0,0,w=c.width,c.height)
              x.globalAlpha=1
              x.fillStyle='#0006'
              x.fillRect(0,0,w=c.width,w)
            }else{
              x.fillStyle='#0006'
              x.fillRect(0,0,w=c.width,w)
            }

            oX=0,oY=0,oZ=14+S(t*3)*4
            Rl=t/4,Pt=0,Yw=t
            iBCsc=3
            G=6

            x.lineJoin=x.lineCap='round'
            if(!t){
              BC=[(-G/2|0)+.5,(G/2|0)+.5,0,[],1,0]
              for(i=6;i--;){
                for(j=4;j--;){
                  BC[3]=[...BC[3],[
                    (a=[S(p=Math.PI*2/4*j+Math.PI/4)*(d=(2**.5)/2),C(p)*d,.5])[i%3]*(l=i<3?1:-1),
                    a[(i+1)%3]*l,
                    a[(i+2)%3]*l]
                  ]
                }
              }
              BCs=Array(iBCsc).fill().map(v=>[JSON.parse(JSON.stringify(BC))])
            }

            if(1){
              BCs.map((q,j)=>{
                for(m=1;m--;){
                  a=JSON.parse(JSON.stringify(q[q.length-1]))
                  n=a[5]
                  if(!(((t*60+j*(20/BCs.length))|0)%3)) n=a[5]=Rn()*6|0
                  tx=a[0]
                  ty=a[1]
                  tz=a[2]
                  tx+=(n==0?1:0)
                  ty+=(n==1?1:0)
                  tz+=(n==2?1:0)
                  tx+=(n==3?-1:0)
                  ty+=(n==4?-1:0)
                  tz+=(n==5?-1:0)
                  tx=Math.max(-G,tx)
                  ty=Math.max(-G,ty)
                  tz=Math.max(-G,tz)
                  tx=Math.min(G,tx)
                  ty=Math.min(G,ty)
                  tz=Math.min(G,tz)
                  a[0]=tx,a[1]=ty,a[2]=tz
                  a[4]=1
                  q.push(a)
                }
              })
            }

            BCs=BCs.map((v,j)=>{
              v.map(v=>{
                a=v[4]/=1.3
                x.strokeStyle=`hsla(${0},99%,${115-(1-a)*75}%,${a/4}`
                x.fillStyle=`hsla(${0},99%,${115-(1-a)*75}%,${a/8}`
                for(m=8;m--;){
                  switch(m){
                    case 0:
                      tx=v[0]
                      ty=v[1]
                      tz=v[2]
                      break
                    case 1:
                      tx=v[0]*-1
                      ty=v[1]
                      tz=v[2]
                      break
                    case 2:
                      tx=v[0]*-1
                      ty=v[1]*-1
                      tz=v[2]
                      break
                    case 3:
                      tx=v[0]*-1
                      ty=v[1]*-1
                      tz=v[2]*-1
                      break
                    case 4:
                      tx=v[0]
                      ty=v[1]*-1
                      tz=v[2]*-1
                      break
                    case 5:
                      tx=v[0]
                      ty=v[1]
                      tz=v[2]*-1
                      break
                    case 6:
                      tx=v[0]*-1
                      ty=v[1]
                      tz=v[2]*-1
                      break
                    case 7:
                      tx=v[0]
                      ty=v[1]*-1
                      tz=v[2]
                      break
                  }
                  v[3].map((v,i)=>{
                    if(i%4==0)x.beginPath()
                    X=v[0]+tx
                    Y=v[1]+ty
                    Z=v[2]+tz
                    R(Rl,Pt,Yw,1)
                    if(Z>0){
                      x.lineTo(...Q())
                      if(i%4==3){
                        x.closePath()
                        x.lineWidth=Math.min(50,1+599/Z/Z)
                        x.stroke()
                        x.fill()
                      }
                    }
                  })
                }
              })
              return v.filter(v=>v[4]>.08)
            })            
            t+=1/60
            
          break
          
          case 8:
          
            if(typeof bgvid !== 'undefined'){
              x.globalAlpha=.6
              x.drawImage(bgvid,0,0,w=c.width,c.height);
              x.globalAlpha=1
            }else{
              x.fillStyle='#0001'
              x.fillRect(0,0,w=c.width,w)
            }
            if(!t){
              iR=c.width/1.5,iV=7,sql=.15,iS=24
              P=[]
            }

            for(m=10;m--;)P=[...P,[c.width/2+S(p=Math.PI*2*Rn())*iR*.95,c.height/2+C(p)*iR*(c.height/c.width),-S(p)*iV,-C(p)*iV,iS,Rn()*80]]
            P.map((v,i)=>{
              aX=v[0]+=v[2]=S(p=Math.atan2(v[2],v[3])+(Rn()-.5)*sql)*iV
              aY=v[1]+=v[3]=C(p)*iV
              x.beginPath()
              x.arc(aX,aY,Math.min(120,((v[4]/=1.01)+1)**2.65/26),0,7)
              x.fillStyle=`hsla(${140+v[5]},99%,${4+Math.hypot(c.width/2-aX,c.height/2-aY)/iR*20}%,${.08*Math.hypot(c.width/2-aX,c.height/2-aY)/iR}`
              x.fill()
            })
            P=P.filter(v=>v[4]>5)

            t+=1/60
          break
          
          case 9:
            if(vid){
              x.globalAlpha=.8
              x.drawImage(bgvid,0,0,w=c.width,c.height)
              x.globalAlpha=1
              x.fillStyle='#0003'
              x.fillRect(0,0,w=c.width,w)
            }else{
              x.fillStyle='#0006'
              x.fillRect(0,0,w=c.width,w)
            }


            Rl=t/4,Pt=-t,Yw=t/2
            oX=0,oY=0,oZ=60+S(t*2)*16
            
            if(!t){
              x.lineJoin=x.lineCap='round'
              cl=3,rw=16*3,s=6
            }
            P=Array(cl).fill().map((v,j)=>{
              return Array(rw).fill().map((v,i)=>{
                l2=1
                l1=rw*l2/16
                d=s+S(Math.PI*2/rw*l1*i)*(.15+C(Math.PI*8/rw*l1*i))**3*2
                X=S(p=Math.PI*2/(rw)*l2*i)*d
                Y=C(p)*d
                Z=0
                R(0,0,Math.PI*2/cl*j,0)
                return [X,Y,Z]
              })
            })
            
            for(k=3**3;k--;){
              tx=((k%3)-1.5+.5)*s*4
              ty=(((k/3|0)%3)-1.5+.5)*s*4
              tz=((k/3/3|0)-1.5+.5)*s*4
              d3=Math.hypot(tx,ty,tz)/16+t*2
              P.map((v,j)=>{
                v.map((q,i)=>{
                  x.beginPath()
                  X=q[0]
                  Y=q[1]
                  Z=q[2]
                  R(t+d3,-t/2+d3,t/3+d3,0)
                  X+=tx,Y+=ty,Z+=tz
                  R(Rl,Pt,Yw,1)
                  x.lineTo(...Q())
                  if(i<v.length-1){
                    X=v[i+1][0]
                    Y=v[i+1][1]
                    Z=v[i+1][2]
                  }else{
                    X=v[0][0]
                    Y=v[0][1]
                    Z=v[0][2]
                  }
                  R(t+d3,-t/2+d3,t/3+d3,0)
                  X+=tx,Y+=ty,Z+=tz
                  R(Rl,Pt,Yw,1)
                  if(Z>5){
                    x.lineTo(...Q())
                    x.strokeStyle='#8fb3'
                    x.lineWidth=Math.min(32,1+50000/Z/Z)
                    x.stroke()
                    x.strokeStyle='#eef8'
                    x.lineWidth=Math.min(12,1+5000/Z/Z)
                    x.stroke()
                  }
                })
              })
            }

            t+=1/60

          break
          
          case 10:

            if(typeof bgvid !== 'undefined'){
              x.globalAlpha=.9
              x.drawImage(bgvid,0,0,w=c.width,c.height);
              x.globalAlpha=1
            }else{
              x.fillStyle='#0006'
              x.fillRect(0,0,w=c.width,w)
            }
            if(!t){
              iR=c.width/1.5,iV=7,sql=.15,iS=24
              P=[]
            }

            for(m=10;m--;)P=[...P,[c.width/2+S(p=Math.PI*2*Rn())*iR*.95,c.height/2+C(p)*iR*(c.height/c.width),-S(p)*iV,-C(p)*iV,iS,Rn()*80]]
            P.map((v,i)=>{
              aX=v[0]+=v[2]=S(p=Math.atan2(v[2],v[3])+(Rn()-.5)*sql)*iV
              aY=v[1]+=v[3]=C(p)*iV
              x.beginPath()
              x.arc(aX,aY,Math.min(120,((v[4]/=1.01)+1)**2.65/26),0,7)
              x.fillStyle=`hsla(${140+v[5]},99%,${4+Math.hypot(c.width/2-aX,c.height/2-aY)/iR*20}%,${.08*Math.hypot(c.width/2-aX,c.height/2-aY)/iR}`
              x.fill()
            })
            P=P.filter(v=>v[4]>5)

            t+=1/60

          break;
          
          case 11:

            if(typeof bgvid !== 'undefined'){
              x.globalAlpha=.3
              x.drawImage(bgvid,0,0,w=c.width,c.height+3);
              x.globalAlpha=1
              x.fillStyle='#0002'
              x.fillRect(0,0,w=c.width,w)
            }else{
              x.fillStyle='#000'
              x.fillRect(0,0,w=c.width,w)
            }
            if(!t){
              x.fillStyle='#000'
              x.fillRect(0,0,w=c.width,w)
            }

            oX=0,oY=0,oZ=16+S(t)*6
            Rl=0,Pt=-t/2,Yw=t

            Rnd=q=>(((q+23))**3.1)%1

            if(!t){
              x.lineJoin=x.lineCap='butt'
              iBr=9,G=8,iPc=3,iPv=.3,iPs=35,iBc=w/3.5|0
              B=Array(iBc).fill().map((v,i)=>{
                s=iBr*((.0001+Rnd(i*4+3))**(1/3))
                X=S(p1=Math.PI*2*Rnd(i*4))*S(p2=Math.PI/2*(Rnd(i*4+1)**.5)-Math.PI*(Rnd(i*4+2)<.5?1:0))*s
                Y=C(p2)*s
                Z=C(p1)*S(p2)*s
                return [X,Y,Z]
              })
              B=B.map(v=>{
                v[3]=[]
                B.map(q=>{
                  v[3].push(Math.hypot(q[0]-v[0],q[1]-v[1],q[2]-v[2]))
                })
                return v
              })
              P=Array(iPc).fill().map((v,i)=>{
                X=(Rnd(i*9+0)-.5)*G
                Y=(Rnd(i*9+1)-.5)*G
                Z=(Rnd(i*9+2)-.5)*G
                return [X,Y,Z,(Rnd(i*9+3)-.5)*iPv,(Rnd(i*9+4)-.5)*iPv,(Rnd(i*9+5)-.5)*iPv]
              })
            }

            B.map((v,i)=>{
              tx=v[0]
              ty=v[1]
              tz=v[2]
              v[3].map((q,j)=>{
                d=.000001+Math.hypot(B[j][0]-v[0],B[j][1]-v[1],B[j][2]-v[2])
                tx-=(B[j][0]-v[0])*(q-d)
                ty-=(B[j][1]-v[1])*(q-d)
                tz-=(B[j][2]-v[2])*(q-d)
              })
              tx/=B.length
              ty/=B.length
              tz/=B.length
              v[0]=v[0]+(tx-v[0])/4
              v[1]=v[1]+(ty-v[1])/4
              v[2]=v[2]+(tz-v[2])/4
              P.map(q=>{
                d=Math.hypot(q[0]-v[0],q[1]-v[1],q[2]-v[2])
                if(d<iPs/6){
                  v[0]=q[0]+(v[0]-q[0])/d*iPs/6
                  v[1]=q[1]+(v[1]-q[1])/d*iPs/6
                  v[2]=q[2]+(v[2]-q[2])/d*iPs/6
                }
              })
              tx=X=v[0]
              ty=Y=v[1]
              tz=Z=v[2]
              R(Rl,Pt,Yw,1)
              s=200/Z
              l=Q()
              x.globalAlpha=.5+S(t/1.75)/2
              x.fillStyle='#ffffff16'
              x.fillRect(l[0]-s*2,l[1]-s*2,s*4,s*4)
              x.fillStyle='#ffffff26'
              x.fillRect(l[0]-s,l[1]-s,s*2,s*2)
              x.fillStyle='#ffffffaf'
              x.fillRect(l[0]-s/3,l[1]-s/3,s/1.5,s/1.5)
            })
            x.globalAlpha=1

            P.map(v=>{
              X=v[0]+=v[3]
              Y=v[1]+=v[4]
              Z=v[2]+=v[5]
              if(v[0]>G)v[3]*=-1
              if(v[0]<-G)v[3]*=-1
              if(v[1]>G)v[4]*=-1
              if(v[1]<-G)v[4]*=-1
              if(v[2]>G)v[5]*=-1
              if(v[2]<-G)v[5]*=-1
              R(Rl,Pt,Yw,1)
              x.beginPath()
              if(Z>0){
                x.arc(...Q(),150*iPs/Z,0,7)
                x.fillStyle=`hsla(${160},99%,50%,${Math.max(0,S(t)/4)}`
                x.fill()
              }
            })
            
            t+=1/60
            
          break;
          
          case 12:
          
            if(!t){
              setTimeout(()=>go=1,400)
              go=0
            }
            if(vidplaying && go){
              x.globalAlpha = 1
              s=8-S(t/2)*7
              for(i=0;i<25;++i){
                X=960+((i%5)-2)*384*s-192*s
                Y=540+((i/5|0)-2)*216*s-108*s
                x.drawImage(bgvid,X,Y,384*s,216*s+5);
              }
              x.globalCompositeOperation='color-dodge'
              x.fillStyle=`#34f`
              x.fillRect(0,0,c.width,c.height)
              x.globalCompositeOperation='source-over'
              X=S(p=t*10)*(d=Math.hypot(960,540))
              Y=C(p)*(d=Math.hypot(960,540))
              g=x.createLinearGradient(960+X,540+Y,960-X,540-Y)
              g.addColorStop(0, `hsla(${t*300+0},99%,${50-S(t*3)*50}%,.4)`)
              g.addColorStop(1, `hsla(${t*300+180},99%,${50-S(t*6)*50}%,.4)`)
              x.fillStyle = g
              x.fillRect(0,0,w=c.width,w)
              x.fillStyle = `hsla(0,0%,0%,${.33+S(t*2)/3})`
              x.fillRect(0,0,w=c.width,w)
            }else{
              x.fillStyle='#000'
              x.fillRect(0,0,w=c.width,w)
            }
          
            x.lineCap='round',R=(n,r,o)=>{Y=S(p=(A=(M=Math).atan2)(Y,Z)+n)*(d=(H=M.hypot)(Y,Z)),Z=C(p)*d,X=S(p=A(X,Z)+r)*(d=H(X,Z)),Z=C(p)*d,Z+=o?6:0};Q=q=>[960+X/Z*L,540+Y/Z*L],a=99,V=1.15,W=.35,B=Array(L=600).fill().map((v,i)=>{j=i/2|0,q=(s=Math.PI)/a*3*j,v=s/a*3*(j+1),X=V*(2+C(q)),Y=S(q)*2,R(Z=0,s*2/a*j),D=X,E=Y,F=Z,X=V*(2+C(v)),Y=S(v)*2,R(Z=0,s*2/a*(j+1)),I=X,J=Y,K=Z
            U=A(I-D,K-F),e=M.acos((J-E)/H(I-D,J-E,K-F)),X=S(p=s*i+s*2/a*j*8)*W,Y=C(p)*W,R(s/2-e,U,Z=0);return[X+D,Y+E,Z+F]})
            for(n=(r=t)*2,j=2;j--;){B.map((v,i)=>{G=`hsla(${.9*i+t*L},99%,${75+S(.002*i+t*6)*35}%,.1)`,X=v[0],Y=v[1],Z=v[2],R(n,r,1);if(j){if(i<L&&!(i%2))x[h='beginPath']();x[O='lineTo'](...Q());if(i<533&&(i%2)==1){x[g='globalAlpha']=1,x[l='lineWidth']=1+50/Z/Z,x[s='strokeStyle']=T='#fffc',x[m='stroke'](),x[l]=L/Z/Z,x[s]=G,x[m]()}}else{if(i>=2){x[g]=1,x[h](),x[O](...Q()),X=B[i-2][0],Y=B[i-2][1],Z=B[i-2][2],R(n,r,1),x[O](...Q()),x[l]=1+50/Z/Z,x[s]=T,x[m](),x[l]=L/Z/Z,x[s]=G,x[m]()}}})}

            t+=1/60
          break
          
          case 13:

            oX=0,oY=0,oZ=12+C(t/2)*4
            Rl=t/2,Pt=-t/4,Yw=S(t/2.5)*10
            

            if(!t){
              go=false
              bgimg=new Image()
              bgimg.addEventListener('load',()=>{
                go=true
              })
              //bgimg.src='MlBFm.jpg'
              bgimg.src='./MlBFm.jpg'
            }

            if(go){
              x.globalAlpha=.075
              x.drawImage(bgimg, 0,0,c.width,c.height)
              x.globalAlpha=1
              x.fillStyle='#1013', x.fillRect(0,0,w=c.width,w)
            }else{
              x.fillStyle='#1026', x.fillRect(0,0,w=c.width,w)
            }
            
            Q=q=>[c.width/2+X/Z*400,c.height/2+Y/Z*400]
            
            if(playing){
              B = new Uint8Array(bufferLength)
              analyser.getByteFrequencyData(B)
              amp=0
              B.map((v,i)=>amp+=v*5**4)
              amp/=550000
            } else {
              trim=0
              B=Array(128).fill(1)
            }
            //B=B.map((v,i)=>{if(i)v=2000;return v})

            rw=50, col=50, sp=9
            for(m=2;m--;){
              for(i=rw*col;i--;){
                x.beginPath()
                j=i+1
                if(m){
                  X=((j%rw)/rw-.5)*sp
                  Z=((j/rw|0)/col-.5)*sp
                }else{
                  Z=((j%rw)/rw-.5)*sp
                  X=((j/rw|0)/col-.5)*sp
                }
                l=Math.hypot(X,Z)/(Math.hypot(rw,col))*1024|0
                d1=-(.75+S(Math.hypot(X,Z)*(3+S(t)*2)-t*10)/4)-B[l]/256*(1+l**.5)/2+.75+(l<2?-.6:0)
                ty=Y=d1*2
                X*=2
                Z*=2
                R(Rl,Pt,Yw,1)
                if(Z>0)x.lineTo(...Q())
                j=i+rw+1
                if(i<rw*col-rw){
                  if(m){
                    X=((j%rw)/rw-.5)*sp
                    Z=((j/rw|0)/col-.5)*sp
                  }else{
                    Z=((j%rw)/rw-.5)*sp
                    X=((j/rw|0)/col-.5)*sp
                  }
                  l=Math.hypot(X,Z)/(Math.hypot(rw,col))*1024|0
                  d=-(.75+S(Math.hypot(X,Z)*(3+S(t)*2)-t*10)/4)-B[l]/256*(1+l**.5)/2+.75+(l<2?-.6:0)
                  Y=d*2
                  X*=2
                  Z*=2
                  R(Rl,Pt,Yw,1)
                  if(Z>0)x.lineTo(...Q())
                }
                x.lineWidth=1
                x.strokeStyle=`hsla(${d1*200-t*300},99%,${70-Math.min(40,Math.abs(d1*25))+(1-ty)**4/3.5}%,${.1-d1/1.5})`
                x.stroke()
              }
            }
            t+=1/60
          break;
        }
      }

      x2.clearRect(0,0,w=canvas2.width|=0,w)
      //x2.save()
      //x2.translate(canvas2.width / 2, canvas2.height / 2)
      //x2.rotate(0)

      sc = 1
      //x2.drawImage(c, -canvas2.width/2*sc, -canvas2.height/2*sc, canvas2.width*sc, canvas2.height*sc)
      x2.drawImage(c,0,0,canvas2.width,canvas2.height)
      //x2.restore()
      requestAnimationFrame(Draw)
    }

    setupAnalyzerAndContent = () =>{
      analyzerSetup=1
      if(!recordingStarted){
        x.lineCap=x.lineJoin='round'
        loaded=0
        mp3 = new Audio()
        mp3.src = song
        if(!mp3)loaded=1
        mp3.addEventListener('canplay',()=>{
          if(!playing){
            loaded=playing=1
            audioCtx = new (window.AudioContext || window.webkitAudioContext)()
            analyser = audioCtx.createAnalyser()
            source = audioCtx.createMediaElementSource(mp3)
            source.connect(analyser)
            analyser.connect(audioCtx.destination)
            analyser.fftSize=fftSize
            trim=analyser.fftSize*.25
            bufferLength = analyser.frequencyBinCount
            mp3.loop = true
            mp3.play()
            if(vid){
              bgvid = document.createElement('video')
              bgvid.src = vid
              bgvid.addEventListener('canplay',()=>{
                if(!vidplaying){
                  vidplaying=1
                  bgvid.loop=true
                  bgvid.play()
                }
              })
            }
          }
        })
      }
    }


    startRecording = () => {
      console.log('recording started')
      recordingStarted=1
      const chunks = []
      const stream = canvas2.captureStream()
      const rec = new MediaRecorder(stream, {videoBitsPerSecond:10000000})
      rec.ondataavailable = e => chunks.push(e.data);
      rec.onstop = e => exportVid(new Blob(chunks, {type: 'video/webm'}));
      rec.start();
      setTimeout(()=>{
        rec.stop()
        canvas2.style.display='none'
        setTimeout(()=>{
          document.querySelectorAll('video').forEach(v=>{
            v.style.display = 'none'
          })
        },200)
        canvas2.style.display='none'
        console.log('recording stopped')
      }, duration);
    }

    exportVid = (blob) => {
      const vid = document.createElement('video')
      vid.src = URL.createObjectURL(blob)
      vid.controls = true
      document.body.appendChild(vid)
      const a = document.createElement('a')
      a.download = 'myvid.webm'
      a.href = vid.src
      a.className='downloadLink'
      a.textContent = 'download the video'
      a.onclick=()=>{
        open(vid.src)
      }
      document.body.appendChild(a)
    }
  
    if(stage2) Draw()
    if(!stage2){
      Draw()
      if(export_base) setTimeout(()=>startRecording(), initialDelay)
    }
  </script>
</html>


